<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>è³“å®¢åå–®ä¸Šå‚³èˆ‡é è¦½</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 0.5em; }
    table { margin-top: 1em; width: 100%; }
    .btn { margin-top: 1em; padding: 0.5em 1em; }
  </style>
</head>
<body>
  <h1>ğŸ“© æ‰¹æ¬¡ä¸Šå‚³è³“å®¢åå–®</h1>

  <input type="file" id="csvFile" accept=".csv" />
  <button class="btn" onclick="previewCSV()">é è¦½åå–®</button>

  <div id="previewContainer"></div>
  <button class="btn" onclick="sendInvitations()">ç”¢ç”Ÿå–œå¸–ä¸¦å¯„é€</button>

  <script>
    let guestData = [];

    function previewCSV() {
      const file = document.getElementById('csvFile').files[0];
      if (!file) return alert("è«‹å…ˆé¸æ“‡CSVæª”");

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          guestData = results.data;
          let tableHTML = `<table><thead><tr>${Object.keys(guestData[0]).map(k => `<th>${k}</th>`).join('')}</tr></thead><tbody>`;
          guestData.forEach(row => {
            tableHTML += `<tr>${Object.values(row).map(v => `<td>${v}</td>`).join('')}</tr>`;
          });
          tableHTML += `</tbody></table>`;
          document.getElementById('previewContainer').innerHTML = tableHTML;
        }
      });
    }

    async function sendInvitations() {
      if (guestData.length === 0) return alert("è«‹å…ˆä¸Šå‚³ä¸¦é è¦½è³‡æ–™");

      try {
        const res = await fetch("http://localhost:3001/generate-wedding-batch", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ guests: guestData })
        });

        const data = await res.json();
        alert("âœ… å·²æˆåŠŸç”¢ç”Ÿèˆ‡å¯„å‡ºå–œå¸–ï¼");
        console.log(data);
      } catch (error) {
        console.error("âŒ éŒ¯èª¤è©³æƒ…ï¼š", JSON.stringify(error, null, 2));
        res.status(500).json({ error: "ç™¼é€å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ä¼ºæœå™¨éŒ¯èª¤è¨Šæ¯ã€‚" });
        }       

    }
  </script>
</body>
</html>
